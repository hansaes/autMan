<!DOCTYPE html>
<html lang="zh">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta name="keywords" content="autMan,后台,后台管理系统">
    <meta name="description" content="后台管理系统。">
    <title>首页 - autMan后台管理系统</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" type="text/css" href="css/materialdesignicons.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="js/bootstrap-multitabs/multitabs.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.min.css">
    <!--对话框插件css-->
    <link rel="stylesheet" type="text/css" href="js/jquery-confirm/jquery-confirm.min.css">
    <!--ztree-->
    <link rel="stylesheet" type="text/css" href="js/zTree_v3/css/materialDesignStyle/materialdesign.css">
    <!--codemirror-->
    <link rel="stylesheet" href="js/codemirror/6.65.7/codemirror.css">
    <script src="js/codemirror/6.65.7/codemirror.js"></script>

    <!--引用的文件用于支持对应语言的语法高亮。-->
    <script src="js/codemirror/6.65.7/mode/javascript/javascript.js"></script>
    <script src="js/codemirror/6.65.7/mode/python/python.min.js"></script>
    <script src="js/codemirror/6.65.7/mode/shell/shell.min.js"></script>
    <script src="js/codemirror/6.65.7/mode/go/go.min.js"></script>

    <!--引入css文件，用以支持主题-->
    <!-- <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/theme/eclipse.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/theme/seti.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/theme/dracula.css"> -->

    <!--引入js，绑定Vim-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/dialog/dialog.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/keymap/vim.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/search/searchcursor.js"></script>

    <!--代码高亮-->
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/selection/active-line.js"></script>

    <!--代码提示-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.js"></script>

    <!--支持代码折叠-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/fold/foldgutter.css" />
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/fold/foldcode.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/fold/foldgutter.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/fold/brace-fold.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/fold/comment-fold.js"></script>

    <!--全屏模式
    <link rel="stylesheet" href="codemirror-5.65.9/addon/display/fullscreen.css">
    <script src="codemirror-5.65.9/addon/display/fullscreen.js"></script>
    -->

    <!--括号匹配-->
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/edit/matchbrackets.js"></script>

    <!--自动补全-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/6.65.7/addon/hint/anyword-hint.js"></script>
    <style>
        .CodeMirror {
            border: 1px solid #eee;
            height: auto !important;
        }
    </style>
</head>

<body class="lyear-index">
    <div class="lyear-layout-web">
        <div class="lyear-layout-container">
            <!--左侧导航-->
            <aside class="lyear-layout-sidebar">
                <!-- logo -->
                <div id="logo" class="sidebar-header">
                    <div class="input-group p-3">
                        <input type="text" class="form-control" placeholder="搜索">
                    </div>
                </div>

                <div class="lyear-layout-sidebar-info lyear-scroll">
                    <!--目录-->
                    <nav class="sidebar-main p-2">
                        <ul id="treeDemo" class="ztree"></ul>
                    </nav>
                </div>
            </aside>
            <!--End 左侧导航-->

            <!--头部信息-->
            <header class="lyear-layout-header">

                <nav class="navbar">

                    <div class="navbar-left">
                        <div class="lyear-aside-toggler">
                            <span class="lyear-toggler-bar"></span>
                            <span class="lyear-toggler-bar"></span>
                            <span class="lyear-toggler-bar"></span>
                        </div>
                    </div>
                    <div class="navbar-left d-flex align-items-center"><a name="jsname" id="jsname"></a></div>

                    <ul class="navbar-right d-flex align-items-center">
                        <a class="btn btn-danger rounded me-2" href="#!" onclick="autDelJsContent()"><i
                                class="mdi mdi-window-close"></i> 删除</a>
                    </ul>
                </nav>
            </header>
            <!--End 头部信息-->

            <!--页面主要内容-->
            <main class="lyear-layout-content">
                <div class="card">
                    <div><textarea id="code" value="text" style="min-height: 100px;"></textarea>
                    </div>
                </div>
            </main>
            <!--End 页面主要内容-->
        </div>

        <!--新建脚本的model-->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6 class="modal-title" id="myModalLabel">新建脚本</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="modal" class="form-horizontal" action="#!" method="post" onsubmit="return false;">
                            <div class="mb-3 row align-items-center">
                                <label class="col-md-3 control-label" for="script_folder">文件夹</label>
                                <div class="col-md-7">
                                    <select class="form-control rounded" name="script_folder" id="script_folder">
                                        <option value="">请选择文件夹</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3 row align-items-center">
                                <label class="col-md-3 control-label" for="script_name">文件名<span class="text-danger">
                                        *</span></label>
                                <div class="col-md-7">
                                    <input class="form-control rounded" type="type" name="script_name" id="script_name">
                                    </select>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-bs-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary"
                                    onclick="autSubmitModalForm()">点击保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!--End 新建脚本的Model-->
    </div>

    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/popper.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/perfect-scrollbar.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-multitabs/multitabs.min.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="js/index.min.js"></script>
    <!--对话框插件js-->
    <script type="text/javascript" src="js/jquery-confirm/jquery-confirm.min.js"></script>
    <!--ztree-->
    <script type="text/javascript" src="js/zTree_v3/js/jquery.ztree.all.min.js"></script>
    <script>
        $(document).ready(function () {
            // 获取容器元素的宽度  
            //var containerWidth = $('#tree').width();

            // function addDiyDom(treeId, treeNode) {
            //     var spaceWidth = 5;
            //     var switchObj = $("#" + treeNode.tId + "_switch"),
            //         icoObj = $("#" + treeNode.tId + "_ico");
            //     switchObj.remove();
            //     icoObj.before(switchObj);

            //     if (treeNode.level > 1) {
            //         var spaceStr = "<span style='display: inline-block;width:" + (spaceWidth * treeNode.level) + "px'></span>";
            //         switchObj.before(spaceStr);
            //     }
            //     var spantxt = $("#" + treeNode.tId + "_span").html();
            //     if (spantxt.length > 17) {
            //         spantxt = spantxt.substring(0, 17) + "...";
            //         $("#" + treeNode.tId + "_span").html(spantxt);
            //     }
            // }

            function addDiyDom(treeId, treeNode) {
                var ztreeWidth = $(".sidebar-main").css("width");
                ztreeWidth = parseInt(ztreeWidth) * 0.75;
                console.log(ztreeWidth)

                //默认ztree字体大小为12px，可以显示字节数（10代表ztree的padding，18代表图标宽度，每一级节点缩进16px）
                var num = parseInt((ztreeWidth - 10 - 18 * (treeNode.level + 1) - 16) / 12 * 2);
                //判断 节点 字节数
                var spantxt = $("#" + treeNode.tId + "_span").html();
                if (spantxt) {
                    var txtLength = GetLength(spantxt);
                }
                //如果 节点数据长度大于允许长度，即将超出时
                var cutNum, cutLength = 0;
                if (txtLength > num) {
                    for (var i = 0; i < spantxt.length; i++) {
                        var charCode = spantxt.charCodeAt(i);
                        if (charCode >= 0 && charCode <= 128) {
                            cutLength += 1;
                        } else {
                            cutLength += 2;
                        }
                        if (cutLength >= num - 2) {
                            cutNum = i;//找到刚符合 允许长度 的字符串的位置
                            break;
                        }
                    }
                    spantxt = spantxt.substring(0, cutNum) + "...";
                    $("#" + treeNode.tId + "_span").html(spantxt);
                }
                //判断 包含汉字和英文的字符串的长度判断方法，判断字节数
                function GetLength(str) {
                    var realLength = 0;
                    for (var i = 0; i < str.length; i++) {
                        var charCode = str.charCodeAt(i);
                        if (charCode >= 0 && charCode <= 128)
                            realLength += 1;
                        else
                            realLength += 2;
                    }
                    return realLength;
                }
            }

            // 树形插件的设置
            var setting = {
                view: {
                    addHoverDom: false,
                    removeHoverDom: false,
                    selectedMulti: false,//设置是否能够同时选中多个节点
                    //showIcon: false,是否显示图标
                    //showTitle: true,
                    addDiyDom: addDiyDom,
                },
                check: {
                    enable: false
                },
                data: {
                    simpleData: {
                        enable: false //设置是否启用简单数据格式（zTree支持标准数据格式跟简单数据格式）
                    }
                },
                // key: {
                //     title: "title"
                // },
                edit: {
                    enable: false
                },
                callback: {//回调函数
                    onClick: function (event, treeId, treeNode) {
                        // 处理节点点击事件  
                        console.log("节点被点击：", treeNode);
                        // 获取选定节点的名称和父节点名称
                        var nodeName = treeNode.name;
                        // 路径
                        var parentName
                        var parent = treeNode.getParentNode();
                        while (parent) {
                            if (parentName) {
                                parentName = parent.name + "/" + parentName
                            } else {
                                parentName = parent.name
                            }
                            parent = parent.getParentNode();
                        }
                        console.log(nodeName, parentName)

                        // 设置当前编辑的插件路径及文件名
                        if (parentName) {
                            $('#jsname').html(parentName + "/" + nodeName)
                        } else {
                            $('#jsname').html(nodeName)
                        }

                        if (!treeNode.is_directory) {
                            // 加载脚本内容
                            $.ajax({
                                'url': `/log/${nodeName}?path=${parentName}`,
                                'type': 'GET',
                                'success': function (data) {
                                    // 在此处处理返回的数据
                                    if (data) {
                                        editor.setValue(data)
                                    }
                                },
                                'error': function (xhr, status, error) {
                                    // 关闭加载动画
                                    console.log('Error:', error);
                                },
                            });
                        }
                    }
                }
            };

            // 初始化zTree
            $.ajax({
                url: "/log/menu",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    console.log(data)
                    zNodes = data;
                    $.fn.zTree.init($("#treeDemo"), setting, zNodes);
                }
            });
        })

        //代码编辑框设置
        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            //Java高亮显示
            mode: "text/javascript",
            //显示行号
            lineNumbers: true,
            //设置主题
            theme: "default",
            //绑定Vim
            //keyMap: "vim",
            //代码折叠
            lineWrapping: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            //全屏模式
            //fullScreen: true,

            scrollbarStyle: null,
            styleActiveLine: true,
            //括号匹配
            matchBrackets: true,
            //智能提示 
            extraKeys: {
                "Ctrl-Space": "autocomplete", //ctrl-space唤起智能提示
                "Ctrl-Q": function (cm) { //Ctrl-Q注释
                    cm.toggleComment();
                },
                "Ctrl-Z": "undo", //撤销
                "Ctrl-Y": "redo", //重做
                "Ctrl-F": "find", //查找
                "Ctrl-G": "findNext", //查找下一个
                "Shift-Ctrl-G": "findPrev", //查找上一个
                "Shift-Ctrl-F": "replace", //替换
                "Shift-Ctrl-R": "replaceAll", //全部替换
            },
        });

        //删除脚本文件-用于删除按钮
        function autDelJsContent() {
            name = $("#jsname").html()
            if (name) {
                $.alert({
                    title: '提示框',
                    content: '确定删除？',
                    buttons: {
                        confirm: {
                            text: '确认',
                            btnClass: 'btn-primary',
                            action: function () {
                                //name以最后一个/分割为路径和文件名
                                path = name.substring(0, name.lastIndexOf("/"))
                                filename = name.substring(name.lastIndexOf("/") + 1)
                                console.log(path, filename)
                                $.ajax({
                                    url: `/scripts?t=${new Date().getTime()}`,
                                    type: 'DELETE',
                                    contentType: "application/json",
                                    data: JSON.stringify({
                                        "filename": filename,
                                        "path": path,
                                    }),
                                    success: function (result) {
                                        if (result.code == 200) {
                                            // 加载目录
                                            updateMenu()
                                            // 清空编辑器
                                            editor.setValue("")
                                            // 清空文件名
                                            $('#jsname').html("")
                                            // 提示删除成功
                                            $.alert("删除成功")
                                        } else {
                                            $.alert("删除失败:" + result)
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.log('Error:', error);
                                    },
                                })
                            }
                        },
                        cancel: {
                            text: '取消',
                            action: function () {
                                //$.alert('你点击了取消!');
                            }
                        }
                    }
                });
            } else {
                $.alert("请在插件目录点选要删除的插件")
            }
        }
    </script>
</body>

</html>